# Niner Supply Train Parallel Bus (NS-TPB) v1.2

## 関連情報
> v2系が上位互換となるため、v2系の使用を推奨しているが、v2は未だ下書き段階である。

- [オリジナル公開ページ（GitHub Gist）](https://gist.github.com/nona-takahara/f12f5e00e5769e5c80a754d7eb40cda3)
- [NS-TPB v2](NS-TPBv2.html)
- [R-BUS \[🔗外部システム\]](https://wikiwiki.jp/sbarjp/%E5%85%B1%E9%80%9A%E8%A6%8F%E6%A0%BC/%E9%89%84%E9%81%93/R-BUS)

### バージョン履歴
- 2021年1月ごろ 下書き公開
- 2021年11月22日 v1.0公開
- 2022年1月31日 v1.1公開
- 2022年2月8日 v1.2公開
- 2023年7月8日 v2移行情報を設置

## 概要

Niner Supply（高原のな）の一般鉄道車両の車両間通信用R-BUS拡張。

基本的に数値チャンネルは制御権車両およびドア扱いを行った車両で書き換え、On/Offチャンネルは全ての車両が必要に応じて書き換える方式をとる。

書き換えを実施しない車両ではパススルー、書き換えを行う車両では前後に適切に処理した情報を送信する。

## 標準マイコン利用者向け情報

|Channel|内容|補足|
|:-:|:-|:-|
||R-BUS拡張ID|基本は1909。1909の場合は以下のルールに沿った実装であることを求める|
|Num 14|前方車両数|出力のみ|
|Num 15|後方車両数|出力のみ|
|Num 16|車両数|出力のみ|
|Num 17|ドア扱いモード(右)|0:全ドア開閉。それ以外の数値の規則は定めない(各々で定める)。全車入力可|
|Num 18|ドア扱いモード(左)|右側と同じ|
|Num 19|1号車側設定|号車番号の若い側がどちらか決定するために使用。R-BUS進行方向と同じ送受信表を用い、自車が進む方向の先端に1号車(等)が存在する。v1.1より全車入力可に変更する|
|Num 20|チャイム・メロディ種別|On/Off 28, 29と組み合わせて使用。全車入力可|
|Num 21|故障ランプ理由|On/Off 26と組み合わせて使用。全車入力可|
|Num 22|種別・方向幕コード|別の用途に使用してもよい。全車入力可|
|Num 23|種別・方向幕コード(追加領域)|別の用途に使用してもよい。全車入力可|
|Num 24|列車番号コード|別の用途に使用してもよい。v1.2より制御権車両優先上書きとする|
|Num 25|走行区間コード|別の用途に使用してもよい。v1.2より制御権車両優先上書きとする|
|Num 26|未使用領域1|(のな式国鉄気動車では、変速機の状態を設定している。0:中立 1:変速 2:直結)|
|Num 27|未使用領域2|(v1.1より)|
|Num 28|未使用領域3|(v1.1より)|
|Num 29|未使用領域4|(v1.1より)|
|Num 30|使用禁止|(v1.1より)|
|Num 31|使用禁止|(v1.1より)|
|Num 32|使用禁止|(v1.1より)|
||
|On/Off 16|ドア開(右-S)|ドア状態用 SRラッチのセットを行う|
|On/Off 17|ドア閉(右-R)|ドア状態用 SRラッチのリセットを行う|
|On/Off 18|ドア開状況(右)|開いているドアがある際にOnにする|
|On/Off 19|ドア開(左-S)|右側と同じ|
|On/Off 20|ドア閉(左-R)|右側と同じ|
|On/Off 21|ドア開状況(左)|右側と同じ|
|On/Off 22|客室照明||
|On/Off 23|客室ヒーター||
|On/Off 24|パンタ一斉操作|Onで上げる。ラッチ実装にし忘れた|
|On/Off 25|乗務員ブザ|長音ブザーください|
|On/Off 26|車両故障・燃料切れ等||
|On/Off 27|車掌弁|実装する際は制御権がある車両が通常のR-BUS領域を用いてEBを送信する。この情報をもとに各車両でEBしてはならない|
|On/Off 28|チャイム・メロディ類起動||
|On/Off 29|チャイム・メロディ類終了|途中で切る際などに使用する。途中切り非対応の場合は無視してよい|
|On/Off 30|その他目的用|(v1.1で変更。回生ブレーキ動作等に使う)|
|On/Off 31|その他目的用|(v1.1より)|
|On/Off 32|使用禁止|(v1.1より)|

## マイコン開発者向け情報
### 用語定義
#### ドアのA側・B側

||定義|
|:-|:-|
|A側|前方からのA側指令は右、後方からのA側指令は左|
|B側|前方からのB側指令は左、後方からのB側指令は右|

### 車両間規則

|Channel|内容|補足|
|:-:|:-|:-|
|Num 15|R-BUS拡張ID|1909とした。定義済みの領域は互換性確保を求める|
|Num 16|車両数|+1して前後にパスする。順序が変わったので注意|
|Num 17|ドア特殊扱い(A)\*|0:全ドア開閉。その他は各相互併結車両間で個別にルールを定めることにする|
|Num 18|ドア特殊扱い(B)\*|A側と同じ(以下、省略)|
|Num 19|1号車側設定(v1.1より\*)|号車番号の若い側がどちらか決定するために使用。進行方向と同じ送受信表を用い、自車が進む方向の先端に1号車(等)が存在する|
|Num 20|チャイム・メロディ種別\*|各相互併結車両間で個別にルールを定めることにするが、原則として、0:基本の車内チャイム 1:乗降促進|
|Num 21|故障ランプ理由\*|各相互併結車両間で個別にルールを定めることにする|
|Num 22|種別・方向幕コード\*|各相互併結車両間で個別にルールを定めることにする|
|Num 23|種別・方向幕コード(追加領域)\*|各相互併結車両間で個別にルールを定めることにする|
|Num 24|予約領域(v1.1より\*)|列番か走行位置を想定|
|Num 25|予約領域(v1.1より\*)|列番か走行位置を想定|
|Num 26|気動車制御コード|各相互併結車両間で個別にルールを定めることにする。のな式国鉄気動車では、0:中立 1:変速 2:直結|
||
|Bool 16|ドア開(A-S)|ドア状態用 SRラッチのセットを行う|
|Bool 17|ドア閉(A-R)|ドア状態用 SRラッチのリセットを行う|
|Bool 18|ドア開状況(A)|開いているドアがある際にOnにする|
|Bool 19|ドア開(B-S)||
|Bool 20|ドア閉(B-R)||
|Bool 21|ドア開状況(B)||
|Bool 22|客室照明||
|Bool 23|客室ヒーター||
|Bool 24|パンタ一斉操作|Onで上げる。ラッチ実装にし忘れた|
|Bool 25|乗務員ブザ|長音ブザーください|
|Bool 26|車両故障・燃料切れ等||
|Bool 27|車掌弁|実装する際は制御権がある車両が通常のR-BUS領域を用いてEBを送信する。この情報をもとに各車両でEBしてはならない|
|Bool 28|チャイム・メロディ類起動|
|Bool 29|チャイム・メロディ類終了|途中切りする際に使用する。途中切り非対応の場合は無視してよい|
|Bool 30|その他目的用|(v1.1で変更。回生ブレーキ動作等に使う)|
|Bool 31|その他目的用|(v1.1より)|
|Bool 32|使用禁止|(v1.1より。内部的に自車Bool 16を送信する)|

### 備考
- 数値のうち、\*を付加した部分は、暫定的にオーバーライドを可能にする。
- ドアスイッチを直接式とする場合もRシグナルをきちんと送るように設計しておかないと、間接車との併結時に問題を起こすので注意する。
