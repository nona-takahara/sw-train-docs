---
layout: "@layouts/Layout.astro"
---
# 宗弥急行プロジェクト デジタルATC

> 現在作成中です。

## 運転士インターフェース

## 保安装置設計（車上）

### 通信プロトコル
#### キーパッドH0 (簡易照査モード)
本保安装置は簡易照査に対応しないため、常に 0 (float)。

#### キーパッドH1 (保安装置判別ID)

絶対値は常に 2 (float)。ただし、以下で述べるE信号の場合は 0 となる。1 秒以上符号が変化しなかった場合はこのキーパッドの値を 0 と読み替える（アドオンウォッチドッグ）。


#### キーパッドH2 (保安装置領域1: 停止信号照査)
30ビット整数値とfloat値の変換はTeinishiによる [Stormworks 数値信号に30ビット詰め込む話 - メモ置き場](https://teinishi.hateblo.jp/entry/stormworks-number-30bit) を採用する。各データの詳細な内容については保安アルゴリズムにて述べる。

|b29-28|b27-b25|b24-b22|b21-b20|b19-b16|b15-b8|b7-b0|
|:-----|:------|:------|:------|:------|:-----|:----|
|信号付加情報|信号種別|勾配コード|信号連続判別コード|信号連続判別フラグ|停止点情報|進路長情報|

#### キーパッドH3 (保安装置領域2: 速度制限照査)
30ビット整数値とfloat値の変換はTeinishiによる [Stormworks 数値信号に30ビット詰め込む話 - メモ置き場](https://teinishi.hateblo.jp/entry/stormworks-number-30bit) を採用する。各データの詳細な内容については保安アルゴリズムにて述べる。

|b29-b25|b24-b20|b19-b16|b15-b8|b7-b0|
|:------|:------|:------|:-----|:----|
|制限速度（上限）|制限速度（パターン下端）|合成パターン演算パラメータ|パターン下端速度制限始点情報|パターン下端速度制限終点情報|

### 保安アルゴリズム

#### 積算走行距離計
進路始端からの距離を測るため、速度を時間積分する距離計を設ける。この距離計は0以上の値にクランプされる。

信号連続判別コード・フラグが変化したとき、この距離計はリセットされる。それ以外の情報が変化した場合は距離計をリセットしない。

#### 信号連続正当性フラグ
信号連続判別コード・フラグが変化したとき、新しい信号連続判別フラグについて、直前の信号連続判別コードに対応するビットが立っていた場合は正当に変化し、ビットが立っていない場合は不正に変化するフラグ。

なお、E信号受信中や、ATC電源切では、信号連続判別コードとして 0, 1, 2, 3 のいずれでもない値を受信しているものとして取り扱う。この状態に変化した場合や、この状態から新たに有効な信号を受信した場合も信号連続判別コード・フラグが変化したものとみなす。

対応関係は以下の通り。

|直前コード|フラグのビット位置|
|:--------|:----------------|
|0|b16|
|1|b17|
|2|b18|
|3|b19|
|その他|対応ビットなし|

#### 信号制御アルゴリズム（H2情報）

信号種別に対応する停止パターンを生成し、制御する。停止点情報・進路長情報は、進路始端からの距離で表されるため、照査パターンとの比較には積算走行距離計を使用する。

なお、信号連続正当性フラグが不正となっている場合は、列車・車両の現在位置が常に 進路長情報 × 10 \[m\] の位置にいるものとみなして照査する。

速度を保った場合に 5 秒後に速度照査パターンに触れる場合、信号現示が×・R・Gの間で変化した場合は現示ベルを鳴動する。それ以外の鳴動タイミングについては追って調整する。

|信号種別|値|備考|
|:------|:-|:---|
|E|0|ウォッチドッグが失敗の場合もEに読み替える|
|A|1|進路始端標識がある区間に使用される|
|B|2|進路始端標識がない区間に使用される|
|S|3|地上信号式の区間に使用されるため車内に現示しない|
|AP|6|高精度制御区間に使用される|
|SP|7|地上信号式の高精度制御区間に使用される。車内に現示しない|

細かい動作の違いについては以下の表の通り。

||E信号|A, B, S信号|AP, SP信号|
|:-|:-|:-|:-|
|非常ブレーキパターン|常時動作|停止点情報 × 10 \[m\] で 0 km/h となる|停止点情報 \[m\] で 0 km/h となる|
|常用ブレーキパターン|常時動作|非常ブレーキパターンの 10 m 外方で 0 km/h となる|照査しないことができる|

||E信号|A信号|B信号|AP信号|S, SP信号|
|:-|:-|:-|:-|:-|:-|
|信号現示|×|停止点情報 < 進路長情報のときR<br>それ以外G|照査速度 < 40 km/h のときR<br>それ以外G|R|車内無現示|

#### 速度制限制御アルゴリズム（H3情報）

速度制限パターンを生成し、制御する。パターン下端速度制限始点情報と、パターン下端速度制限終点情報は、進路始端からの距離で表されるため、照査パターンとの比較には積算走行距離計を使用する。

なお、信号連続正当性フラグが不正となっている場合は、常に制限速度（パターン下端）で照査する（下端速度の頭打ち制御区間内の照査方法で照査すればよい）。

速度を保った場合に 5 秒後に速度照査パターンに触れる場合、制限速度（パターン下限）の区間から脱出した場合、速度制限（上限）が上位に変化した場合に現示ベルが鳴動する。

合成パターン演算パラメータは現状使用していない。

パターンの生成方法は以下の図の通りとする。

（図は作成中）
