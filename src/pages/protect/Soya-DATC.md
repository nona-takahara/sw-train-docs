---
layout: "@layouts/Layout.astro"
---
# 宗弥急行プロジェクト デジタルATC

## 運転士インターフェース

## 保安装置設計（車上）

### 通信プロトコル

#### 型 Speed

|値|速度情報(H2用)|速度情報(H3用)|
|:-|:---|:--|
|0|無信号|制限なし|
|1|非常停止 02|進行信号ブレーキ出力制御用|
|2|停止 01|踏切等停止パターン発生用|
|3|入換 S25|併合パターン発生用|
|4|入換 S40|停止位置2段パターン発生用|
|5-7|予約|予約|
|8-31|`(val - 5) * 5`|`(val - 5) * 5`|

#### 型 Gradient

|値|情報|
|:-|:---|
|0|下り35‰より大|
|1|下り35‰ - 下り25‰|
|2|下り25‰ - 下り15‰|
|3|下り15‰ - 下り5‰|
|4|下り5‰ - 上り5‰|
|5|上り5‰ - 上り15‰|
|6|上り15‰ - 上り25‰|
|7|上り25‰より大|

#### 型 Deceleration

|値|速度制限B 演算減速度|
|:-|:---|
|0|Bパターンなし|
|1|3.50 km/h/s|
|2|3.00 km/h/s|
|3|2.50 km/h/s|
|4|2.25 km/h/s|
|5|2.00 km/h/s|
|6|1.75 km/h/s|
|7|1.50 km/h/s|

#### 型 DiffSpeed

|値|速度制限B - 速度制限A|
|:-|:---|
|0|5 km/h|
|1|10 km/h|
|2|15 km/h|
|3|20 km/h|
|4|25 km/h|
|5|30 km/h|
|6|35 km/h|
|7|40 km/h|

#### キーパッドH0 (簡易照査モード)
本保安装置は簡易照査に対応しない。

0 (float)

#### キーパッドH1 (保安装置判別ID)
1 (float)

#### キーパッドH2 (保安装置領域1: 停止信号照査)
30ビット整数値とfloat値の変換はTeinishiによる [Stormworks 数値信号に30ビット詰め込む話 - メモ置き場](https://teinishi.hateblo.jp/entry/stormworks-number-30bit) を採用する。

各距離は、信号連続性判別が正当である場合、進路の始端からの距離となる。正当でない場合、現在位置は常に進路区間長の位置と解釈される。

|b29-b25|b24-b22|b21-b20|b19-b16|b15-b8|b7-b0|
|:------|:------|:------|:------|:-----|:----|
|進路の最高速度(型 Speed)|勾配(型 Gradient)|信号連続性判別コード|信号連続性判別フラグ(b16: 0, ..., b19: 3)|停止点距離(m) / 10|進路区間長(m) / 10|

#### キーパッドH3 (保安装置領域2: 速度制限照査)
30ビット整数値とfloat値の変換はTeinishiによる [Stormworks 数値信号に30ビット詰め込む話 - メモ置き場](https://teinishi.hateblo.jp/entry/stormworks-number-30bit) を採用する。

各距離は、信号連続性判別が正当である場合、進路の始端からの距離となる。正当でない場合、現在位置は常に進路区間長の位置と解釈される。

予備には進行方向情報を含めたい。また、速度情報4のときでも、停止点距離がH2とH3で一致しない場合は停止目標近接パターンを生成しない。

|速度情報|b29-b25|b24-b22|b21-b19|b18-b16|b15-b8|b7-b0|
|:-------|:------|:------|:------|:------|:-----|:----|
|4を除く|速度制限A 制限速度(型 Speed)|速度制限B 演算パターン減速度(型 Deceleration)|予備|速度制限B 速度差分(型 DiffSpeed)|速度制限A 始点距離(m) / 10|速度制限A 終点距離(m) / 10|
|4|0b00100|速度制限B 演算パターン減速度(型 Deceleration)|予備|速度制限B 速度差分(型 DiffSpeed) 制限A は0と解釈|停止点距離(m) / 10|停止点に対する二段目パターンの終点(m)|

### 保安アルゴリズム

#### 積算走行距離計
進路始端からの距離を測るため、速度を時間積分する距離計を設ける。この距離計は0以上進路区間長以下の値にクランプされる。また、進路区間長に一致している間は逆向きの速度によって減少できないようにする。

次の条件を満たしたとき、それぞれの条件による値に更新される。以降はこの距離計の値を「進路始端から進んだ距離」と表現する。

- 信号連続性判別フラグが更新されたとき
    - 直前の判別コードに該当する信号連続性判別フラグが立っていた場合、距離を0にセットする
    - 直前の判別コードに該当する信号連続性判別フラグが立っていない場合、距離を進路区間長にセットする
- ATCが起動するとき
    - 距離を進路区間長にセットする
