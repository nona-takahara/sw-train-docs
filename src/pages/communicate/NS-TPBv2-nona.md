---
layout: "@layouts/Layout.astro"
---
# NS-TPB v2 Nona 実装 インターフェース

## 関連情報

> 仕様は現在、かなり流動的です

- [オリジナル公開ページ（GitHub Gist）](https://gist.github.com/nona-takahara/ce034eead45771aa897cd03514bb9102)
- [NS-TPB v2](NS-TPBv2.html)
- [R-BUS \[🔗 外部システム\]](https://wikiwiki.jp/sbarjp/%E5%85%B1%E9%80%9A%E8%A6%8F%E6%A0%BC/%E9%89%84%E9%81%93/R-BUS)

## Service (NS-TPB v2 N-Sv)

Service マイコンは、各車 1 両設置し、R-BUS 制御情報を受け取り、TPB の制御情報を送信する。運転台情報もこのマイコンで送信する都合、出力情報は非常に多くなっている。alpha10 より前のバージョンでは RX という名称であった。

### 入力

| チャンネル | 内容     | 備考 |
| ---------- | -------- | ---- |
| Input-N21  | 故障情報 |      |

| チャンネル | 内容                           | 備考                                                                                              |
| ---------- | ------------------------------ | ------------------------------------------------------------------------------------------------- |
| Input-B18  | ドア開状況(A)                  | 開いているドアがある場合は On<br>和を送信                                                         |
| Input-B21  | ドア開状況(B)                  | 開いているドアがある場合は On<br>和を送信                                                         |
| Input-B26  | 非常通報・故障                 |                                                                                                   |
| Input-B27  | 非常ブレーキ請求               |                                                                                                   |
| Input-B28  | 編成分離非常ブレーキ抑制（前） | Sv マイコンでは、標準で車両数認識により車掌弁入力を設定しているが、これを抑止する際に On を入れる |
| Input-B29  | 編成分離非常ブレーキ抑制（後） |                                                                                                   |

### 出力

| チャンネル | 内容                   | 備考                                                                                         |
| ---------- | ---------------------- | -------------------------------------------------------------------------------------------- |
| Output-N1  | ブレーキ               | 1 を受信したとき最大レベルのブレーキが動作することを求める（1 以外の値に対する挙動は自由）。 |
| Output-N2  | 進行方向               | R-BUS による反転関連は解釈済み                                                               |
| Output-N3  | スロットル             | 0 以上 1 以下                                                                                |
| Output-N4  | 速度                   | 0 以上の実数<br>R-BUS v1.1 で示した指針で設計                                                |
|            |                        |                                                                                              |
| Output-N16 | 全車両数               |                                                                                              |
| Output-N17 | ドア特殊扱い(A)        | 0 は全扉の開閉。その他の値は各々で定める。<br>後出し優先排他・自己保持制御                   |
| Output-N18 | ドア特殊扱い(B)        | 上に同じ                                                                                     |
| Output-N19 | 号車番号（開始値 1）   | 0 の場合、制御権側を 1 とみなす                                                              |
| Output-N20 | チャイム・メロディ種別 |                                                                                              |
| Output-N21 | 故障情報               |                                                                                              |
| Output-N22 | 表示器 1 設定          |                                                                                              |
| Output-N23 | 表示器 2 設定          |                                                                                              |
| Output-N24 | 表示器 3 設定          |                                                                                              |
| Output-N25 | 表示器 4 設定          |                                                                                              |
| Output-N26 | 追加制御用領域 1       |                                                                                              |
| Output-N27 | 追加制御用領域 2       |                                                                                              |
| Output-N28 | 追加制御用領域 3       |                                                                                              |
| Output-N29 | 追加制御用領域 4       |                                                                                              |
| Output-N30 | 前方向車両数           |                                                                                              |
| Output-N31 | 後方向車両数           |                                                                                              |
| Output-N32 |                        |                                                                                              |

| チャンネル | 内容                     | 備考                                                                   |
| ---------- | ------------------------ | ---------------------------------------------------------------------- |
| Output-B1  | 車両起動(互換領域)       | R-BUS との互換領域                                                     |
| Output-B2  | NS-TPB 制御有効          |                                                                        |
|            |                          |                                                                        |
| Output-B16 | ドア開(A-S)              | ドア状態ラッチのセットを行う                                           |
| Output-B17 | ドア閉(A-R)              | ドア状態ラッチのリセットを行う<br>ただし、セットが来ている間は閉じない |
| Output-B18 | ドア開状況(A)            | 自車を含めて、開いているドアがある場合は On<br>和を送信                |
| Output-B19 | ドア開(B-S)              | ドア状態ラッチのセットを行う                                           |
| Output-B20 | ドア閉(B-R)              | ドア状態ラッチのリセットを行う<br>ただし、セットが来ている間は閉じない |
| Output-B21 | ドア開状況(B)            | 自車を含めて、開いているドアがある場合は On<br>和を送信                |
| Output-B22 | 客室照明                 |                                                                        |
| Output-B23 | 客室ヒーター             |                                                                        |
| Output-B24 | パンタグラフ             |                                                                        |
| Output-B25 | 乗務員ブザー             |                                                                        |
| Output-B26 | 非常通報・故障           |                                                                        |
| Output-B27 | 非常ブレーキ請求         |                                                                        |
| Output-B28 | チャイム・メロディ類起動 |                                                                        |
| Output-B29 | チャイム・メロディ類終了 |                                                                        |
| Output-B30 | エンジン                 |                                                                        |
| Output-B31 | 走行用バッテリー         |                                                                        |
| Output-B32 | ドア開状況(AB 合成)      | 自車を含めて、開いているドアがあると On                                |

## Operation (NS-TPB v2 N-Op)

Operation マイコンは、運転士・車掌による入力を取り扱う。alpha10 より前のバージョンでは TX という名称であった。

### 入力

断りない場合は R-BUS / NS-TPB の仕様に従う

| チャンネル | 制御権条件 | 内容                   | 備考                                                |
| ---------- | ---------- | ---------------------- | --------------------------------------------------- |
| Input-N1   | ○          | ブレーキ               |                                                     |
| Input-N2   | ○          | 進行方向               | 前に進むならば 1<br>後に進むならば-1                |
| Input-N3   | ○          | スロットル             |                                                     |
| Input-N4   | ○          | 目標回転数             |                                                     |
|            |            |                        |                                                     |
| Input-N17  |            | ドア特殊扱い(A)        |                                                     |
| Input-N18  |            | ドア特殊扱い(B)        |                                                     |
| Input-N19  |            | 1 号車側設定           | 前が 1 号車ならば-1<br>後が 1 号車ならば 1 (未実装) |
| Input-N20  |            | チャイム・メロディ種別 |                                                     |
| Input-N21  |            | （故障情報）           | 送信自体は可能だが、基本的に Sv マイコンから送信    |
| Input-N22  |            | 表示器 1 設定          |                                                     |
| Input-N23  |            | 表示器 2 設定          |                                                     |
| Input-N24  |            | 表示器 3 設定          |                                                     |
| Input-N25  |            | 表示器 4 設定          |                                                     |
| Input-N26  | ○          | 追加制御用領域 1       |                                                     |
| Input-N27  | ○          | 追加制御用領域 2       |                                                     |
| Input-N28  | ○          | 追加制御用領域 3       |                                                     |
| Input-N29  | ○          | 追加制御用領域 4       |                                                     |

| チャンネル | 制御権条件 | 内容                           | 備考                                                                                    |
| ---------- | ---------- | ------------------------------ | --------------------------------------------------------------------------------------- |
| Input-B1   | ○          | 車両起動（互換領域）           | R-BUS との互換領域                                                                      |
| Input-B2   | ！         | 制御権請求                     |                                                                                         |
| Input-B3   | ☆          | 負論理<br>パンタグラフ降下     | 上昇優先の動作をする（降下するには上昇をオフにする必要がある）                          |
| Input-B4   | ☆          | 負論理<br>エンジン停止         | 起動優先の動作をする（停止するには起動をオフにする必要がある）                          |
| Input-B5   | ☆          | 負論理<br>走行用バッテリー停止 | 起動優先の動作をする（停止するには起動をオフにする必要がある）                          |
|            |            |                                |                                                                                         |
| Input-B16  |            | ドア開(A-S)                    | ドア状態ラッチのセットを行う                                                            |
| Input-B17  |            | ドア閉(A-R)                    | ドア状態ラッチのリセットを行う<br>On にしたままにするとセット信号をトグルのように扱える |
| Input-B18  |            |                                |                                                                                         |
| Input-B19  |            | ドア開(B-S)                    | ドア状態ラッチのセットを行う                                                            |
| Input-B20  |            | ドア閉(B-R)                    | ドア状態ラッチのリセットを行う<br>On にしたままにするとセット信号をトグルのように扱える |
| Input-B21  |            |                                |                                                                                         |
| Input-B22  |            | 客室照明                       | 和                                                                                      |
| Input-B23  |            | 客室ヒーター                   | 和                                                                                      |
| Input-B24  |            | パンタグラフ上昇               |                                                                                         |
| Input-B25  |            | 乗務員ブザー                   |                                                                                         |
| Input-B26  |            | （非常通報・故障）             | 送信自体は可能だが、基本的に RX マイコンから送信                                        |
| Input-B27  |            | 車掌弁                         |                                                                                         |
| Input-B28  |            | チャイム・メロディ類起動       |                                                                                         |
| Input-B29  |            | チャイム・メロディ類終了       |                                                                                         |
| Input-B30  |            | エンジン起動                   |                                                                                         |
| Input-B31  |            | 走行用バッテリー起動           |                                                                                         |
| Input-B32  |            |                                |                                                                                         |

### 出力

基本的に RX マイコンの出力を使用すればよい。

| チャンネル | 内容         | 備考               |
| ---------- | ------------ | ------------------ |
| Output-B2  | 制御権情報   |                    |
| Output-B25 | 乗務員ブザー | 他車からの情報のみ |

## Converter

以下の内容は、必要に応じて搭載することとする。

### Brake Pipe to apply Emergency Brake (NS-TPB with BP)

ウィンチ接続判定システムの利用を前提とし、[中宗電鉄拡張 - 電気指令式ブレーキ車用救援機能方針(下書き \| Notion)](https://www.notion.so/c2d5a2ee624344cf8e502f4742f66e50?pvs=21) の機能を実現する。

### A-TAS Connection (NS-TPB converter for A-TAS)

A-TAS は TPB を参考に開発されていることもあり、高原によるコンバートシステムを提供することにした。

## General use controller

Sv マイコンや Op マイコン向けの汎用コントローラ。作るかは決めてない。
